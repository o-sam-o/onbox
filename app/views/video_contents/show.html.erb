<% content_for :head do %>

<script type="text/javascript" src="/accordionview/utilities.js"></script>
<link rel="stylesheet" type="text/css" href="/accordionview/assets/skins/sam/accordionview.css">
<script type="text/javascript" src="/accordionview/accordionview.js"></script>

<%= render :partial => 'shared/yui_table_header' %>

<link rel="stylesheet" type="text/css" href="<%= ONBOX_CONFIG[:yui_path] %>/tabview/assets/skins/sam/tabview.css">
<script type="text/javascript" src="/accordionview/tabview-min.js"></script>

<!-- YUI Dialog -->
<link rel="stylesheet" type="text/css" href="<%= ONBOX_CONFIG[:yui_path] %>/container/assets/skins/sam/container.css">
<script src="<%= ONBOX_CONFIG[:yui_path] %>/animation/animation-min.js"></script>
<script src="<%= ONBOX_CONFIG[:yui_path] %>/dragdrop/dragdrop-min.js"></script>
<script src="<%= ONBOX_CONFIG[:yui_path] %>/container/container-min.js"></script>
<script type="text/javascript" src="<%= ONBOX_CONFIG[:yui_path] %>/button/button-min.js"></script> 

<style>

.yui-dt table
{
    width: 100%;
}

.yui-button {
	vertical-align: bottom;
}
</style>
<% end %>

<% content_for :title do %>
  On Box: <%=h @video_content.display_name %>
<% end %>

<div class="viewWrapper overclear">
	<div class="viewCoreMetadata">
		<div id="showTypeIconWrapper">
			<%=image_tag @video_content.movie? ? 'movie.png' : 'tv_show.png', :alt => @video_content.movie? ? 'Movie' : 'Tv Show', :title => @video_content.movie? ? 'Movie' : 'Tv Show'%>
		</div>		
		<div id="watchedWrapper" class="<%= 'notWatched' unless @watched %>">
			<a id="watchedContentLink" class="fakeLink" onclick="markVideoWatched(<%= !@watched %>); return false" href="#"><%=image_tag "watched.png" %></a>
			<%=yui_tooltip "watchedContentLink", @watched ? "Watched" : "Click to mark video as watched" %>
		</div>
		<h1 class="viewTitle"><%=h @video_content.display_name %></h1>
		<div class="viewPlotSummary"><%=h @video_content.plot %></div>
		<div class="viewCoreDetailsWrapper overclear">
			<div class="viewCoreDetailsLeft">
				<div>
					<div class="viewDetailsLabel">Imdb Id:</div>
					<div class="viewDetailsValue">
						<% if @video_content.imdb_id %>
							<a href="http://www.imdb.com/title/tt<%=h @video_content.imdb_id %>"><%=h @video_content.imdb_id %></a>
						<% else %>
							IMDB Id Unknown
						<% end %>
					</div>
				</div>				
				<%= view_content_details "Director", @video_content.director %>	
				<%= view_content_details "Runtime", @video_content.runtime_formatted %>				
			</div>
			<div class="viewCoreDetailsRight">
				<%= view_content_details "Status", VideoContentState.display_name(@video_content.state) %>	
				<%= view_content_details "Release Date", @video_content.release_date %>	
				<%= view_content_details "Language", @video_content.language %>		
				<%= view_content_details "Tagline", @video_content.tag_line %>				
			</div>
		</div>
		<% unless @video_content.genres.empty? %>
			<div class="viewCoreGenres">
				<span class="viewGenreLabel">Genres:</span> 
				<% @video_content.genres.each do |genre| %>
					<a href="<%= home_search_path [genre.name.downcase] %>"><%= genre.name %></a><%= ', ' unless genre == @video_content.genres.last %>
				<% end %>
			</div>
		<% end %>
		
		<div id="viewAccordionWrapper" class="hiddenDiv">
			<div class="viewAccordion">
				<ul id="topAccordion"> 
				    <li> 
			            <div>Files</div> 
			            <div> 
							<div class="accordionContent">
								<%= render :partial => 'video_files', :object => @video_content.video_file_references %>
							</div>
						</div>
					</li>
					<!--  Doesnt seem to work in dev, server hangs
					    <li> 
				            <div>Video</div> 
				            <div> 
								<div class="accordionContent">
									<% unless @video_content.video_file_references.empty? %>
										<object classid="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B" 
											codebase="http://www.apple.com/qtactivex/qtplugin.cab">
										 	<param name="src" 
												value="<%= video_file_reference_path(@video_content.video_file_references.first) %>" />
										 	<param name="controller" value="true" />
										</object>
									<% end %>
								</div>
							</div>
						</li>				
					-->
					<% if @video_content.tv_show? && @video_content.tv_episodes.present? %>
						<li> 
				            <div>Episodes</div> 
				            <div> 
								<div class="accordionContent">
									<%= render :partial => 'episodes' %>
								</div>
							</div>
						</li>
					<% end %>
				</ul>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		YAHOO.util.Event.addListener(window, "load", function() {

			var topMenu = new YAHOO.widget.AccordionView('topAccordion', {width: '550px', animationSpeed: '0.6', animate: true,  
															expandable: true, collapsible: true, effect: YAHOO.util.Easing.easeNone});

			<% unless @video_content.video_file_references.empty? %>
				<% # This is very dodgy but cutlery makes html go missing if this accordion is rendered. Turning off for cuke tests %>
				<% if ONBOX_CONFIG[:show_file_accordion] %>
					var fileMenu = new YAHOO.widget.AccordionView('filesAccordion', {width: '520px', animationSpeed: '0.5', animate: true, 
					 		 								expandable: true, collapsible: true, effect: YAHOO.util.Easing.easeNone
														    <%= ', expandItem: 0' if @video_content.video_file_references.size == 1 %>});
				<% end %>
				<% # Id like this to be in video_files partial but it needs to be init after the AccordionViews 
				   # as otherwise tab selection doesnt work %>	
				<% @video_content.video_file_references.each do |file| %>
					<% if not file.video_file_properties.empty? %>
						var fileTabView<%= file.id %> = new YAHOO.widget.TabView('filePropertyTab<%= file.id %>');
						fileTabView<%= file.id %>.set('activeIndex', 0);
					<% end %>
				<% end %>
				
			<% end %>
			<% if @video_content.tv_show? && @video_content.tv_episodes.present? %>
				var episodeMenu = new YAHOO.widget.AccordionView('episodesAccordion', {width: '520px', animationSpeed: '0.5', animate: true, 
													expandable: true, collapsible: true, effect: YAHOO.util.Easing.easeNone
													<%= ', expandItem: 0' if @video_content.tv_episodes.group_by_series.size == 1 %>});
			<% end %>
			YAHOO.util.Dom.removeClass('viewAccordionWrapper', 'hiddenDiv'); 												
		});
	</script>	
	
	<div class="viewPosterWrapper">
		<div class="overclear">
			<% if @video_content.poster(:large) %>
				<img src="<%= url_for video_content_video_poster_path(@video_content, @video_content.poster(:large)) %>"
				 	class="viewPosterLargeImg"/>
			<% elsif @video_content.poster(:small) %>
				<img src="<%= url_for video_content_video_poster_path(@video_content, @video_content.poster(:small)) %>"
				 	class="viewPosterSmallImg" width="100" height="140"/>
			<% else %>
				<img src="/images/no_preview.jpg" class="viewPosterSmallImg" width="100" height="140"/>
			<% end %>
		</div>
		<div class="viewActionsWrapper">
			<% if current_user %>
				<%= yui_button_link :text => 'Edit Details', :link => edit_video_content_path(@video_content) %>
				<%= yui_button_link :text => 'Change Imdb Id', :onclick => 'changeImdbId()' %>
				<%= yui_button_link :text => 'Refresh', :onclick => 'reloadFromImdb()' %>
			<% end %>
		</div>
	</div>
	
	<div id="changeImdbDialog" class="yui-pe-content hiddenDiv"> 
		<div class="hd">Change Imdb Id</div> 
		<div class="bd"> 
			<div id="changeImdbDialogTabs" class="yui-navset">
			    <ul class="yui-nav">
			        <li class="selected"><a href="#enterIdTab"><em>Enter Id</em></a></li>
					<li><a href="#tab2"><em>Search</em></a></li>
				</ul>
				<div class="yui-content">
				<div id="enterIdTab">
					<% form_tag reload_video_content_path(@video_content), :method => :post, :class => 'defaultForm' do %>
					  <fieldset>
					      <legend>Details:</legend>
						  <div class="defaultFormField">
						    <%= label_tag "imdb_id", "Imdb Id" %>
						    <%= text_field_tag 'imdb_id', @video_content.imdb_id, :class => "defaultFormTextField" %>
						  </div>
					  </fieldset>
					<% end %>
				</div>
				<div id="searchTab">
					  <form class="defaultForm">
						<fieldset>
					      <legend>Search:</legend>
						  <div class="defaultFormField">
						    <%= label_tag "search_term" %>
						    <%= text_field_tag 'search_term', (@video_content.video_file_references.empty? ? @video_content.name : Util::FileNameCleaner.get_name_info(@video_content.video_file_references.first.location).name), :class => "defaultFormTextField" %>
						    <%= yui_button_link :text => 'Search', :onclick => 'searchImdb()' %>
						  </div>
					  	</fieldset>
						<div id="imdbSearchResult"/>						
					  </form>
				</div>
			</div>
		</div> 
	</div>
	
	<script>
		YAHOO.namespace("onbox.video.imdb");
		YAHOO.util.Event.addListener(window, "load", function() {

			// Define various event handlers for Dialog
			var handleSubmit = function() {
				this.submit();
			};
			var handleCancel = function() {
				this.cancel();
			};

			// Instantiate the Dialog
			YAHOO.onbox.video.imdb.dialog = new YAHOO.widget.Dialog("changeImdbDialog", 
									{ width : "600px",
									  fixedcenter : true,
									  visible : false,
									  postmethod : 'form',
									  constraintoviewport : true,
									  buttons : [ { text:"Change", handler:handleSubmit, isDefault:true },
										      { text:"Cancel", handler:handleCancel } ]
									});

			// Validate the entries in the form to require that both first and last name are entered
			YAHOO.onbox.video.imdb.dialog.validate = function() {
				var data = this.getData();
				if (data.imdb_id == "") {
					alert("You must provide an IMDB id.");
					return false;
				} else {
					return true;
				}
			};
			YAHOO.onbox.video.imdb.tabs = new YAHOO.widget.TabView('changeImdbDialogTabs'); 
			
			// Render the Dialog
			YAHOO.onbox.video.imdb.dialog.render();
			// Make visable
			YAHOO.util.Dom.removeClass("changeImdbDialog", "hiddenDiv");

		});	
		
		function changeImdbId() {
			YAHOO.onbox.video.imdb.dialog.show()
		}
		
		function reloadFromImdb(imdb_id) {
			if (imdb_id){
				$('imdb_id').setValue(imdb_id);
			}
			if (!YAHOO.onbox.video.imdb.dialog.getData().imdb_id){
				//We cant reload from imdb if we dont have an id, show set imdb dialog
				changeImdbId();
				return;
			}
			YAHOO.onbox.video.imdb.dialog.submit()
		}
		
		function searchImdb(){
			var searchTerm = $('search_term').getValue();
			if (searchTerm == ''){
				alert('Please enter a search term');
				return;
			}
			$('imdbSearchResult').innerHTML = '<div style="font-weight:bold;padding: 5px;" align="center">Searching for ' + searchTerm + '...</div>';
			new Ajax.Updater('imdbSearchResult', '<%= search_imdb_video_content_path(@video_content) %>', 
			{ method: 'get', parameters: {search_term: searchTerm}, evalScripts: true });
		}
		
		
		function markVideoWatched(watched){
			if (!is_logged_in()){
				window.location = "<%= login_path %>";
				return;
			}
			new Ajax.Request('<%= watch_video_content_path(@video_content) %>',
			  {
			    method:'post',
				parameters: {watched: watched},
			    onSuccess: function(transport){
			      if(transport.responseText == "true"){
					if(watched){
						YAHOO.util.Dom.removeClass('watchedWrapper', 'notWatched'); 
						document.getElementById('watchedContentLink').onclick = function(){markVideoWatched(false);};
						changeTooltip('watchedContentLink', 'Watched');
					}else{
						YAHOO.util.Dom.addClass('watchedWrapper', 'notWatched'); 
						document.getElementById('watchedContentLink').onclick = function(){markVideoWatched(true);};
						changeTooltip('watchedContentLink', 'Click to mark as watched');
					}
			      }else{
					alert('Error marking video watched: ' + transport.responseText)
				  }
			    },
			    onFailure: function(){ alert('Failed to mark video as watched.') }
			  });
		}
		
		function changeTooltip(element_id, new_message){
			eval('var tt_var = var_tt_' + element_id)			
			tt_var.destroy();
			tt_var = new YAHOO.widget.Tooltip("tt_" + element_id, { context: element_id, text: new_message });
			eval('var_tt_' + element_id + ' = tt_var')
		}
		
		function is_logged_in(){
		 return <%= current_user.present? %>;
		}
	
	</script>
</div>